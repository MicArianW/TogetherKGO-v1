name: Auto-Merge Pending Publish PRs

on:
  schedule:
    # Monday at 10AM ET
    - cron: "00 14 * * 1"
    - cron: "00 14 * * 3"
    - cron: "00 14 * * 5"
    
  workflow_dispatch:

jobs:
  merge_pending_publish_prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # Checkout repository for gh commands
      - uses: actions/checkout@v4

      # Gather all open PRs with the label
      - name: Gather PRs with label "decap-cms/pending_publish"
        id: gather
        run: |
          prs=$(gh pr list \
            --state open \
            --label "decap-cms/pending_publish" \
            --json number \
            --jq '.[].number' | paste -sd "," -)
          echo "prs=$prs" >> $GITHUB_OUTPUT

      # Merge each PR
      - name: Merge PRs
        if: steps.gather.outputs.prs != ''
        run: |
          # Split comma-separated PR numbers into an array
          IFS=',' read -ra prs_array <<< "${{ steps.gather.outputs.prs }}"
          
          for pr in "${prs_array[@]}"; do
            echo "Processing PR #$pr"

            # Skip workflow-changing PRs
            changed_files=$(gh pr view "$pr" --json files --jq '.files[].path')
            if echo "$changed_files" | grep -q '^.github/workflows/'; then
              echo "Skipping PR #$pr because it modifies workflows"
              continue
            fi

            # Merge PR immediately
            gh pr merge "$pr" --squash --admin || \
              echo "Failed to merge PR #$pr - verify CI/checks"
          done

      # Log if no PRs found
      - name: No PRs found
        if: steps.gather.outputs.prs == ''
        run: echo "No pending_publish PRs found to merge."
